{% extends "layout.html" %}

{% block title %}Stock Valuation Report{% endblock %}
{% block page_title %}Stock Valuation Report{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <a href="{{ url_for('inventory.dashboard') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
    </a>
    <button class="btn btn-outline-success ms-2" onclick="printReport()">
        <i class="fas fa-print me-1"></i> Print Report
    </button>
    <a href="{{ url_for('inventory.export_stock_valuation') }}" class="btn btn-outline-primary ms-2">
        <i class="fas fa-file-excel me-1"></i> Export to Excel
    </a>
</div>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header bg-transparent">
        <form method="get" class="row g-2">
            <div class="col-md-3">
                <select class="form-select" id="warehouse_id" name="warehouse_id">
                    <option value="">All Warehouses</option>
                    {% for warehouse in warehouses %}
                    <option value="{{ warehouse.id }}" {% if request.args.get('warehouse_id')|int == warehouse.id %}selected{% endif %}>
                        {{ warehouse.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="category_id" name="category_id">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if request.args.get('category_id')|int == category.id %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <input type="text" class="form-control" id="search" name="search" placeholder="Search by product name or SKU" value="{{ request.args.get('search', '') }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="sort" name="sort" onchange="this.form.submit()">
                    <option value="name" {% if request.args.get('sort') == 'name' %}selected{% endif %}>Sort by Name</option>
                    <option value="value_high" {% if request.args.get('sort') == 'value_high' %}selected{% endif %}>Value (High to Low)</option>
                    <option value="value_low" {% if request.args.get('sort') == 'value_low' %}selected{% endif %}>Value (Low to High)</option>
                    <option value="quantity_high" {% if request.args.get('sort') == 'quantity_high' %}selected{% endif %}>Quantity (High to Low)</option>
                    <option value="quantity_low" {% if request.args.get('sort') == 'quantity_low' %}selected{% endif %}>Quantity (Low to High)</option>
                </select>
            </div>
        </form>
    </div>
</div>

<div id="report-content">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Stock Valuation as of {{ datetime_now.strftime('%Y-%m-%d %H:%M') }}</h5>
            <div>
                <span class="badge bg-primary">Total Value: ${{ '{:,.2f}'.format(total_value) }}</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Product</th>
                            <th>Category</th>
                            {% if not request.args.get('warehouse_id') %}
                            <th>Warehouse</th>
                            {% endif %}
                            <th class="text-end">Quantity</th>
                            <th class="text-end">Cost per Unit</th>
                            <th class="text-end">Total Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in stock_items %}
                        <tr>
                            <td>{{ item.product.sku }}</td>
                            <td>
                                <a href="{{ url_for('inventory.view_product', product_id=item.product.id) }}">
                                    {{ item.product.name }}
                                </a>
                            </td>
                            <td>{{ item.product.category.name if item.product.category else 'Uncategorized' }}</td>
                            {% if not request.args.get('warehouse_id') %}
                            <td>{{ item.warehouse.name }}</td>
                            {% endif %}
                            <td class="text-end">{{ item.quantity }} {{ item.product.uom.abbreviation }}</td>
                            <td class="text-end">${{ '{:.2f}'.format(item.product.cost_price) }}</td>
                            <td class="text-end">${{ '{:.2f}'.format(item.quantity * item.product.cost_price) }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="{% if not request.args.get('warehouse_id') %}7{% else %}6{% endif %}" class="text-center py-3">
                                No stock items found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="{% if not request.args.get('warehouse_id') %}6{% else %}5{% endif %}" class="text-end">Total:</th>
                            <th class="text-end">${{ '{:,.2f}'.format(total_value) }}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    {% if show_by_category %}
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Stock Value by Category</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th class="text-end">Value</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category, value in category_totals %}
                                <tr>
                                    <td>{{ category }}</td>
                                    <td class="text-end">${{ '{:,.2f}'.format(value) }}</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" 
                                                style="width: {{ (value / total_value * 100)|round|int if total_value > 0 else 0 }}%" 
                                                aria-valuenow="{{ (value / total_value * 100)|round|int if total_value > 0 else 0 }}" 
                                                aria-valuemin="0" 
                                                aria-valuemax="100">
                                                {{ (value / total_value * 100)|round|int if total_value > 0 else 0 }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-4">
                    <canvas id="categoryChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if show_by_warehouse %}
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Stock Value by Warehouse</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Warehouse</th>
                                    <th class="text-end">Value</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for warehouse, value in warehouse_totals %}
                                <tr>
                                    <td>{{ warehouse }}</td>
                                    <td class="text-end">${{ '{:,.2f}'.format(value) }}</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" 
                                                style="width: {{ (value / total_value * 100)|round|int if total_value > 0 else 0 }}%" 
                                                aria-valuenow="{{ (value / total_value * 100)|round|int if total_value > 0 else 0 }}" 
                                                aria-valuemin="0" 
                                                aria-valuemax="100">
                                                {{ (value / total_value * 100)|round|int if total_value > 0 else 0 }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-4">
                    <canvas id="warehouseChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Print function
    function printReport() {
        const printContents = document.getElementById('report-content').innerHTML;
        const originalContents = document.body.innerHTML;
        
        document.body.innerHTML = `
            <header class="d-print-none">
                <h1 class="text-center">Stock Valuation Report</h1>
                <p class="text-center">Generated on {{ datetime_now.strftime('%Y-%m-%d %H:%M') }}</p>
            </header>
            ${printContents}
        `;
        
        window.print();
        document.body.innerHTML = originalContents;
    }
    
    // Charts
    document.addEventListener('DOMContentLoaded', function() {
        {% if show_by_category %}
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        new Chart(categoryCtx, {
            type: 'pie',
            data: {
                labels: [{% for category, value in category_totals %}'{{ category }}',{% endfor %}],
                datasets: [{
                    data: [{% for category, value in category_totals %}{{ value }},{% endfor %}],
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                        '#5a5c69', '#6f42c1', '#20c997', '#fd7e14', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: 'Stock Value by Category'
                    }
                }
            }
        });
        {% endif %}
        
        {% if show_by_warehouse %}
        const warehouseCtx = document.getElementById('warehouseChart').getContext('2d');
        new Chart(warehouseCtx, {
            type: 'pie',
            data: {
                labels: [{% for warehouse, value in warehouse_totals %}'{{ warehouse }}',{% endfor %}],
                datasets: [{
                    data: [{% for warehouse, value in warehouse_totals %}{{ value }},{% endfor %}],
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                        '#5a5c69', '#6f42c1', '#20c997', '#fd7e14', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: 'Stock Value by Warehouse'
                    }
                }
            }
        });
        {% endif %}
    });
</script>
{% endblock %}